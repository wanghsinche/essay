# 新版通用前端发布系统搭建
> 组里新的前端发布系统基本开发完成了。新平台将老的发布系统功能做了删减和修改，变成依赖npm的前端通用发布系统。本文主要是简单介绍发布平台的技术实现，和开发过程中遇到的一些问题及其解决方案。
## 平台功能介绍
组里目前用的前端构建工具是经过修改的百度fis3，每次发布项目需要从gitlab拉取代码，运行构建命令，同步资源文件到测试机或正式cdn，并将发布记录入库。为了修改成通用的前端发布平台，新版系统需要实现的功能点有：
1. 基本的api服务器，用于项目信息查询，用户管理，和权限控制
2. 基于npm的通用前端发布环境和部署工具
3. 线上站点版本回退功能，用于误操作时的紧急恢复
## 技术实现
### api服务器部分
api服务器功能基本延续旧版发布系统。考虑到接口参数验证，权限控制和线上监控的问题，新版api服务器用restify框架重写。
由于是内部工具平台，并发量不高，这部分实现起来相对简单。
### 前端项目构建和发布部分
该部分是发布系统的核心功能，旧版本发布系统没有与api服务器解耦，直接在controller里用child_process模块调用系统命令完成构建并发布。这种设计有几个缺点：
1. 系统命令调用多用异步函数实现，导致发布过程需要处理大量回调函数或者promise，代码不够直观，不利于后续维护更新
2. 每一个系统命令都需要再次封装成js函数，增加了很多不必要的代码
3. child_process模块每次调用外部程序都会新建一个子进程，每次构建发布项目需要运行好几个外部命令，资源浪费严重。
所以，需要重新设计这部分功能。可行的方案有两种：
- 把api服务器和发布系统分开成两个程序。api服务器提交发布请求到发布系统，发布系统开始构建并部署，并将结果推送给api服务器，由api服务器返回给客户端。
- 把前端构建和发布过程都写成bash脚本，api服务器用child_process的spawn方法调用脚本，完成构建。 

两种方法各有优缺点，第一种办法实现了解耦，两个程序之间用消息中间件或者rpc相互通信，可以玩出很多很有意思的花样--可以分开开发，也可以分别部署到不同的服务器，对单元测试也比较友好。但系统比较复杂，工作量增加不少。两个程序之间的通信还需要引入很多额外的东西，对于一个内部工具平台来说，不够划算。 

相比而言，第二种方法更加简单。api服务器直接调用bash脚本完成构建和发布工作，几乎不用处理异步函数，也基本不用担心nodejs大量生成子进程调用外部命令导致的性能问题。但是这种方法也有一些缺点：

1. bash脚本需要传入的参数很多，用环境变量传参的方法比较合理，但这也为后续的构建埋下了陷阱。
2. bash脚本处理字符串功能很弱，sed，egrep等命令并不好用，还需要写额外node脚本为生成的资源文件打标记等等。
3. bash脚本在远端服务器上出错很难调试，而且不好定位问题。

虽然有上述缺点，但方案2还是比较划算的，新版发布系统最终选择了这种方案。

### 线上版本回退功能
为了防止错误发布上线，线上版本回退是很重要的。新版发布系统延续老平台的做法，每次发布正式时同时备份一份到备份文件夹，由于静态文件都有hash，所以回退时只要替换线上html即可。

### 多页面前端webpack构建环境
...
