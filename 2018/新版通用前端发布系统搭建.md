# 新版通用前端发布系统搭建
> 组里新的前端发布系统基本开发完成了。新平台将老的发布系统功能做了删减和修改，变成依赖npm的前端通用发布系统。本文主要是简单介绍发布平台的技术实现，和开发过程中遇到的一些问题及其解决方案。
## 平台功能介绍
组里目前用的前端构建工具是经过修改的百度fis3，发布系统发布的时候从gitlab拉取代码，运行构建命令，同步资源文件到测试机或正式cdn，并将发布记录入库。因此新版发布平台需要实现的功能点有：

1. 基本的api服务器，用于项目信息查询，用户管理，和权限控制
2. 基于npm的通用前端发布环境和部署工具
3. 线上站点版本回退功能，用于误操作时的紧急恢复
## 技术实现
### api服务器部分
api服务器功能基本延续旧版发布系统。考虑到接口参数验证，权限控制和线上监控的问题，新版api服务器用restify框架重写。
由于是内部工具平台，并发量不高，这部分实现起来相对简单。
### 前端项目构建和发布部分
该部分是发布系统的核心功能，旧版本发布系统没有与api服务器解耦，直接在controller里用child_process模块调用系统命令完成构建并发布。这种设计有几个缺点：
1. 系统命令调用多用异步函数实现，导致发布过程需要处理大量回调函数或者promise，代码不够直观，不利于后续维护更新
2. 每一个系统命令都需要再次封装成js函数，增加了很多不必要的代码
3. child_process模块每次调用外部程序都会新建一个子进程，每次构建发布项目需要运行好几个外部命令，资源浪费严重。

